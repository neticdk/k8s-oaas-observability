{{/* validate flux CRDs */}}
{{- if .Values.alerting.enabled }}
  {{- if not (.Capabilities.APIVersions.Has "source.toolkit.fluxcd.io/v1beta2") }}
          {{ fail "alerting requires source.toolkit.fluxcd.io/v1beta2 CRDs." }}
  {{- end }}
  {{- if not (.Capabilities.APIVersions.Has "helm.toolkit.fluxcd.io/v2beta1") }}
          {{ fail "alerting requires helm.toolkit.fluxcd.io/v2beta1 CRDs." }}
  {{- end }}
{{- end }}

{{/* validate cluster_id is defined */}}
{{- if .Values.alerting.enabled }}
  {{- if (eq .Values.alerting.clusterId "") }}
    {{ fail "alerting is enabled, clusterId must be defined and set to the value of the label cluster_id" }}
  {{- end }}
{{- end }}

{{/* validate only 1 preset is defined */}}
{{- if .Values.global.presets }}
  {{- $count := 0 -}}
  {{- range $key, $value := .Values.global.presets -}}
    {{- if eq $value true -}}
      {{- $count = add $count 1 -}}
    {{- end -}}
  {{- end -}}

  {{- if gt $count 1 -}}
    {{ fail "More than 1 preset is enabled" }}
  {{- end }}
{{- end }}
